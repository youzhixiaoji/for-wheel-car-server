<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>遥控驾驶界面</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />

  <style>
    :root{
      --page-gradient: radial-gradient(circle at 20% 18%, #1c2b5a, #0a1226 52%, #040813 100%);
      --shell-overlay: linear-gradient(155deg, rgba(148, 163, 184, 0.22), rgba(14, 116, 144, 0.26));
      --screen-glass: rgba(14, 23, 42, 0.85);
      --block-glass: rgba(12, 18, 33, 0.68);
      --pad-surface: rgba(8, 12, 24, 0.72);
      --accent: #60a5fa;
      --accent-strong: #3b82f6;
      --accent-soft: rgba(96, 165, 250, 0.22);
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --shadow: 0 32px 84px rgba(3, 7, 18, 0.7);
    }

    *{box-sizing:border-box;}

    body{
      margin:0;
      min-height:100vh;
      padding:18px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:var(--page-gradient);
      color:var(--text-primary);
      font-family:"Segoe UI","PingFang SC","Microsoft YaHei",sans-serif;
    }

    .app-wrap{
      width:100%;
      max-width:1600px;
    }

    .device-outline{
      padding:40px;
      border-radius:48px;
      background:var(--shell-overlay);
      box-shadow:var(--shadow);
      position:relative;
    }

    .device-screen{
      position:relative;
      padding:42px clamp(28px, 5.5vw, 62px);
      border-radius:32px;
      background:transparent;
      backdrop-filter:none;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      gap:28px;
    }

    .device-screen::before{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(circle at 80% 15%, rgba(96, 165, 250, 0.14), transparent 58%),
        radial-gradient(circle at 14% 88%, rgba(129, 140, 248, 0.12), transparent 60%);
      pointer-events:none;
    }

    .top-strip,
    .bottom-strip{
      position:relative;
      z-index:1;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      flex-wrap:wrap;
    }

    .brand{
      font-size:20px;
      font-weight:600;
      letter-spacing:0.08em;
    }

    .subtitle{
      font-size:14px;
      color:var(--text-secondary);
    }

    .status-pill{
      padding:10px 18px;
      border-radius:999px;
      background:rgba(14, 116, 144, 0.32);
      color:#5eead4;
      font-size:13px;
      font-weight:500;
      backdrop-filter:blur(10px);
    }

    .control-grid{
      position:relative;
      z-index:1;
      display:grid;
      grid-template-columns:minmax(0, 1.2fr) minmax(0, 1.87fr) minmax(0, 1.2fr);
      grid-template-areas:"drive video camera";
      gap:44px;
      align-items:stretch;
    }

    .column{
      display:flex;
      flex-direction:column;
    }

    .column-drive{grid-area:drive;}
    .column-video{grid-area:video;}
    .column-camera{grid-area:camera;}

    .block{
      background:transparent;
      border-radius:32px;
      padding:58px;
      border:0;
      backdrop-filter:none;
      flex:1;
      display:flex;
      justify-content:center;
      align-items:center;
    }

    .pad{
      margin:0;
      border-radius:30px;
      display:grid;
      gap:20px;
      width:min(100%, 374px);
      justify-content:center;
    }

    .drive-pad{
      grid-template-areas:
        ". drive-up ."
        "drive-left drive-stop drive-right"
        ". drive-down .";
      grid-template-columns:repeat(3, 104px);
      grid-template-rows:repeat(3, 104px);
    }

    .camera-pad{
      grid-template-areas:
        ". cam-up ."
        "cam-left . cam-right"
        ". cam-down .";
      grid-template-columns:repeat(3, 104px);
      grid-template-rows:repeat(3, 104px);
    }

    .control-key{
      border:1px solid rgba(96, 165, 250, 0.28);
      border-radius:28px;
      background:var(--accent-soft);
      color:var(--text-primary);
      font-size:19px;
      font-weight:600;
      letter-spacing:0.02em;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all 0.15s ease;
      cursor:pointer;
      user-select:none;
      width:100%;
      height:100%;
    }

    .control-key:hover{
      background:rgba(96, 165, 250, 0.32);
      border-color:var(--accent);
    }

    .control-key:active{
      transform:translateY(1px);
      background:var(--accent-strong);
      border-color:var(--accent-strong);
    }

    .drive-pad .control-key{
      background:rgba(96, 165, 250, 0.2);
    }

    .drive-pad .drive-stop{
      background:rgba(248, 113, 113, 0.22);
      border-color:rgba(248, 113, 113, 0.3);
      color:#fecaca;
    }

    .drive-pad .drive-stop:hover{
      background:rgba(248, 113, 113, 0.32);
      border-color:#f87171;
    }

    .drive-pad .drive-stop:active{
      background:#f87171;
      border-color:#ef4444;
    }

    .drive-pad .drive-up{grid-area:drive-up;}
    .drive-pad .drive-down{grid-area:drive-down;}
    .drive-pad .drive-left{grid-area:drive-left;}
    .drive-pad .drive-right{grid-area:drive-right;}
    .drive-pad .drive-stop{grid-area:drive-stop;}

    .camera-pad .cam-up{grid-area:cam-up;}
    .camera-pad .cam-down{grid-area:cam-down;}
    .camera-pad .cam-left{grid-area:cam-left;}
    .camera-pad .cam-right{grid-area:cam-right;}

    .video-wrapper{
      background:transparent;
      border-radius:0;
      padding:0;
      position:relative;
      overflow:visible;
      display:flex;
      justify-content:center;
      align-items:center;
      box-shadow:none;
      border:0;
      width:100%;
    }

    .video-wrapper::before{
      content:none;
    }

    .video-frame{
      position:relative;
      border-radius:26px;
      overflow:hidden;
      background:#020617;
      display:flex;
      align-items:center;
      justify-content:center;
      width:min(100%, 912px);
      aspect-ratio:4 / 3;
    }

    .video-frame img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    .bottom-strip p{
      margin:0;
      font-size:13px;
      color:var(--text-muted);
      letter-spacing:0.04em;
    }

    @media (max-width: 1024px){
      body{padding:18px;}
      .device-outline{padding:30px;border-radius:42px;}
      .device-screen{padding:32px;}
      .control-grid{gap:30px;}
    }

    @media (max-width: 640px){
      body{padding:12px;}
      .device-outline{padding:18px;}
      .device-screen{padding:22px;}
      .brand{font-size:18px;}
      .pad{width:min(100%, 330px);gap:14px;justify-content:center;}
      .drive-pad{grid-template-columns:repeat(3, 84px);grid-template-rows:repeat(3, 84px);}
      .camera-pad{grid-template-columns:repeat(3, 84px);grid-template-rows:repeat(3, 84px);}
      .control-key{font-size:17px;border-radius:22px;}
    }

    @media (max-width: 900px) and (orientation: portrait){
      .device-screen{padding:18px;}
      .control-grid{
        grid-template-columns:repeat(2, minmax(0, 1fr));
        grid-template-areas:
          "video video"
          "drive camera";
        gap:16px;
      }
      .block{
        background:transparent;
        border:0;
        backdrop-filter:none;
        padding:0;
      }
      .pad{width:100%;max-width:none;gap:12px;}
      .pad.drive-pad,
      .pad.camera-pad{
        grid-template-columns:repeat(3, minmax(0, 1fr));
        grid-template-rows:repeat(3, minmax(0, 1fr));
      }
      .control-key{
        aspect-ratio:1 / 1;
        border-radius:20px;
        font-size:18px;
      }
      .video-wrapper{padding:0;}
      .video-frame{width:100%;}
    }

    @media (max-width: 900px) and (orientation: landscape){
      .device-screen{padding:18px;}
      .control-grid{
        grid-template-columns: minmax(0, 0.95fr) minmax(0, 1.4fr) minmax(0, 0.95fr);
        grid-template-areas: "drive video camera";
        gap:10px;
        align-items:center;
      }
      .column-drive,
      .column-camera{
        order:0;
      }
      .block{
        padding:0;
        background:transparent;
        border:0;
        backdrop-filter:none;
        box-shadow:none;
        display:flex;
        justify-content:center;
        align-items:center;
      }
      .pad{
        width:100%;
        max-width:220px;
        gap:10px;
      }
      .pad.drive-pad,
      .pad.camera-pad{
        grid-template-columns:repeat(3, 54px);
        grid-template-rows:repeat(3, 54px);
      }
      .control-key{
        aspect-ratio:1 / 1;
        border-radius:14px;
        font-size:14px;
      }
      .video-wrapper{padding:0;justify-content:center;}
      .video-frame{
        width:min(100%, 520px);
        max-width:min(520px, calc(100vw - 260px));
        max-height:390px;
        aspect-ratio:4 / 3;
        border-radius:20px;
      }
    }
  </style>
</head>
<body>
  <div class="app-wrap">
    <div class="device-outline">
      <div class="device-screen">
        <div class="top-strip"></div>

        <div class="control-grid">
          <div class="column column-drive">
            <div class="block">
              <div class="pad drive-pad">
                <button class="control-key drive-up"
                        onmousedown="drive('forward', 'press')" onmouseup="drive('forward', 'release')"
                        ontouchstart="drive('forward', 'press')" ontouchend="drive('forward', 'release')" ontouchcancel="drive('forward', 'release')">前</button>
                <button class="control-key drive-left"
                        onmousedown="drive('turnLeft', 'press')" onmouseup="drive('turnLeft', 'release')"
                        ontouchstart="drive('turnLeft', 'press')" ontouchend="drive('turnLeft', 'release')" ontouchcancel="drive('turnLeft', 'release')">左</button>
                <button class="control-key drive-stop"
                        onclick="drive('stopMove', 'press')"
                        ontouchstart="drive('stopMove', 'press')">停</button>
                <button class="control-key drive-right"
                        onmousedown="drive('turnRight', 'press')" onmouseup="drive('turnRight', 'release')"
                        ontouchstart="drive('turnRight', 'press')" ontouchend="drive('turnRight', 'release')" ontouchcancel="drive('turnRight', 'release')">右</button>
                <button class="control-key drive-down"
                        onmousedown="drive('backward', 'press')" onmouseup="drive('backward', 'release')"
                        ontouchstart="drive('backward', 'press')" ontouchend="drive('backward', 'release')" ontouchcancel="drive('backward', 'release')">后</button>
              </div>
            </div>
          </div>

          <div class="column column-video">
            <div class="video-wrapper">
              <div class="video-frame">
                <img id="video" src="/video_feed" alt="实时驾驶画面" width="912" height="684" />
              </div>
            </div>
          </div>

          <div class="column column-camera">
            <div class="block">
              <div class="pad camera-pad">
                <button class="control-key cam-up"
                        onmousedown="cam('up', 'press')" onmouseup="cam('up', 'release')"
                        ontouchstart="cam('up', 'press')" ontouchend="cam('up', 'release')" ontouchcancel="cam('up', 'release')">上</button>
                <button class="control-key cam-left"
                        onmousedown="cam('left', 'press')" onmouseup="cam('left', 'release')"
                        ontouchstart="cam('left', 'press')" ontouchend="cam('left', 'release')" ontouchcancel="cam('left', 'release')">左</button>
                <button class="control-key cam-right"
                        onmousedown="cam('right', 'press')" onmouseup="cam('right', 'release')"
                        ontouchstart="cam('right', 'press')" ontouchend="cam('right', 'release')" ontouchcancel="cam('right', 'release')">右</button>
                <button class="control-key cam-down"
                        onmousedown="cam('down', 'press')" onmouseup="cam('down', 'release')"
                        ontouchstart="cam('down', 'press')" ontouchend="cam('down', 'release')" ontouchcancel="cam('down', 'release')">下</button>
              </div>
            </div>
          </div>
        </div>

        <div class="bottom-strip">
          <p>键盘快捷键：W / A / S / D 控制车体，R 触发急停，I / J / K / L 调整云台方向。</p>
          <div class="status-pill">有只小鸡</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentSpeed = 'mid';

    async function drive(direction, actionType = 'press'){
      try{
        await fetch('/drive', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            direction,
            speed: currentSpeed,
            action_type: actionType
          })
        });
      }catch(err){
        console.error('drive error', err);
      }
    }

    async function cam(direction, actionType = 'press'){
      try{
        await fetch('/camera', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            direction,
            speed: currentSpeed,
            action_type: actionType
          })
        });
      }catch(err){
        console.error('camera error', err);
      }
    }

    const driveKeyMap = {
      w: 'forward',
      s: 'backward',
      a: 'turnLeft',
      d: 'turnRight'
    };

    const cameraKeyMap = {
      i: 'up',
      j: 'left',
      k: 'down',
      l: 'right'
    };

    const activeDriveKeys = new Set();
    const activeCameraKeys = new Set();

    document.addEventListener('keydown', (event) => {
      const lower = event.key.toLowerCase();
      if(lower in driveKeyMap){
        if(!activeDriveKeys.has(lower)){
          event.preventDefault();
          activeDriveKeys.add(lower);
          drive(driveKeyMap[lower], 'press');
        }
        return;
      }

      if(lower === 'r'){
        event.preventDefault();
        drive('stopMove', 'press');
        return;
      }

      if(lower in cameraKeyMap && !activeCameraKeys.has(lower)){
        event.preventDefault();
        activeCameraKeys.add(lower);
        cam(cameraKeyMap[lower], 'press');
      }
    });

    document.addEventListener('keyup', (event) => {
      const lower = event.key.toLowerCase();
      if(activeDriveKeys.has(lower)){
        activeDriveKeys.delete(lower);
        drive(driveKeyMap[lower], 'release');
        return;
      }

      if(activeCameraKeys.has(lower)){
        activeCameraKeys.delete(lower);
        cam(cameraKeyMap[lower], 'release');
      }
    });

    window.addEventListener('blur', () => {
      activeDriveKeys.forEach(activeKey => {
        drive(driveKeyMap[activeKey], 'release');
      });
      activeDriveKeys.clear();

      activeCameraKeys.forEach(activeKey => {
        cam(cameraKeyMap[activeKey], 'release');
      });
      activeCameraKeys.clear();
    });
  </script>
</body>
</html>
